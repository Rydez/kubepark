.PHONY: help setup build deploy-park deploy-carousel deploy-restroom list-restrooms remove-restrooms status logs clean open-grafana restart-monitoring reload-dashboards reset-dashboards

# Default target
help:
	@echo "🎢 KubePark Game Commands"
	@echo ""
	@echo "Setup & Build:"
	@echo "  setup           Create Kind cluster and start monitoring stack"
	@echo "  build           Build and push the game image"
	@echo ""
	@echo "Game Commands:"
	@echo "  deploy-park     Start the park (begins the game!)"
	@echo "  deploy-carousel Deploy carousel attraction"
	@echo "  deploy-restroom Deploy restroom attraction (creates new instance each time)"
	@echo "  list-restrooms  Show all deployed restroom instances"
	@echo "  remove-restrooms Remove all restroom instances"
	@echo ""
	@echo "Monitoring:"
	@echo "  status          Show current park status"
	@echo "  logs            View park logs"
	@echo "  open-grafana    Open Grafana dashboard"
	@echo "  restart-monitoring Restart monitoring stack"
	@echo "  restart-alloy   Restart Alloy log collection"
	@echo "  upgrade-alloy   Upgrade Alloy with latest configuration"
	@echo "  reload-dashboards Reload Grafana dashboards"
	@echo "  reset-dashboards Complete dashboard reset (clears cache)"
	@echo ""
	@echo "Cleanup:"
	@echo "  clean           Clean up everything"

# Setup infrastructure
setup:
	@echo "🏗️  Setting up KubePark infrastructure..."
	@echo "Creating Kind cluster with local registry..."
	@cd cluster && ./kind-with-registry.sh
	@echo "Starting monitoring stack..."
	@docker-compose up -d
	@echo "Waiting for monitoring stack to be ready..."
	@sleep 10
	@echo "Setting up Kubernetes resources..."
	@kubectl apply -f k8s/base/
	@echo "Adding Grafana Helm repository..."
	@helm repo add grafana https://grafana.github.io/helm-charts
	@helm repo update
	@echo "Deploying log collection (Alloy) using Helm..."
	@helm upgrade --install alloy grafana/alloy --namespace alloy --values k8s/alloy-values.yaml --wait
	@echo "✅ Setup complete! Run 'make build' next."

# Build and push image
build:
	@echo "🔨 Building KubePark image..."
	@cd .. && docker build -t localhost:5001/kubepark .
	@echo "📤 Pushing image to local registry..."
	@docker push localhost:5001/kubepark:latest
	@echo "✅ Build complete! Run 'make deploy-park' to start the game."

# Deploy park service
deploy-park:
	@echo "🎪 Starting the park..."
	@kubectl apply -f k8s/park.yaml
	@echo "⏳ Waiting for park to be ready..."
	@kubectl wait --for=condition=available --timeout=60s deployment/park -n park
	@echo "✅ Park is open! Check status with 'make status'"

# Deploy carousel attraction
deploy-carousel:
	@echo "🎠 Deploying carousel attraction..."
	@INSTANCE_ID=$$(date +%s)-$$(shuf -i 1000-9999 -n 1); \
	ATTRACTION_TYPE=carousel; \
	export INSTANCE_ID ATTRACTION_TYPE; \
	envsubst < k8s/attraction.yaml | kubectl apply -f -
	@echo "⏳ Waiting for carousel to be ready..."
	@INSTANCE_NAME=$$(kubectl get deployments -n attractions -l attraction=carousel --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.name}'); \
	kubectl wait --for=condition=available --timeout=60s deployment/$$INSTANCE_NAME -n attractions
	@echo "✅ Carousel is operational!"

# List all restroom instances
list-carousels:
	@echo "🚻 Deployed Carousel Instances:"
	@echo "==============================="
	@kubectl get deployments,services -n attractions -l attraction=carousel --no-headers 2>/dev/null | \
	awk '{print "📍 " $$1 " - " $$2}' || echo "No carousels deployed yet"
	@echo ""
	@echo "💡 Run 'make deploy-carousel' to add more carousels to your park!"


# Deploy restroom attraction
deploy-restroom:
	@echo "🚻 Deploying restroom attraction..."
	@INSTANCE_ID=$$(date +%s)-$$(shuf -i 1000-9999 -n 1); \
	ATTRACTION_TYPE=restroom; \
	export INSTANCE_ID ATTRACTION_TYPE; \
	envsubst < k8s/attraction.yaml | kubectl apply -f -
	@echo "⏳ Waiting for restroom to be ready..."
	@INSTANCE_NAME=$$(kubectl get deployments -n attractions -l attraction=restroom --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.name}'); \
	kubectl wait --for=condition=available --timeout=60s deployment/$$INSTANCE_NAME -n attractions
	@echo "✅ Restroom is operational!"

# List all restroom instances
list-restrooms:
	@echo "🚻 Deployed Restroom Instances:"
	@echo "==============================="
	@kubectl get deployments,services -n attractions -l attraction=restroom --no-headers 2>/dev/null | \
	awk '{print "📍 " $$1 " - " $$2}' || echo "No restrooms deployed yet"
	@echo ""
	@echo "💡 Run 'make deploy-restroom' to add more restrooms to your park!"

# Show status
status:
	@echo "🎢 KubePark Status"
	@echo "=================="
	@echo ""
	@echo "📊 Cluster Status:"
	@kubectl get nodes
	@echo ""
	@echo "🎪 Park Services:"
	@kubectl get pods,svc -n park
	@echo ""
	@echo "🎠 Attractions:"
	@kubectl get pods,svc -n attractions
	@echo ""
	@echo "👥 Guests:"
	@kubectl get jobs,pods -n guests 2>/dev/null || echo "No guest jobs currently running (managed by park service)"
	@echo ""
	@echo "📈 Monitoring:"
	@docker-compose ps
	@echo ""
	@echo "📋 Log Collection:"
	@kubectl get pods -n alloy -l app.kubernetes.io/name=alloy

# View logs
logs:
	@echo "📋 Recent park logs:"
	@kubectl logs -n park deployment/park --tail=20 || echo "Park not deployed yet"

# Open Grafana
open-grafana:
	@echo "📊 Opening Grafana dashboard..."
	@echo "URL: http://localhost:3000"
	@echo "Username: admin"
	@echo "Password: admin"
	@open http://localhost:3000 2>/dev/null || echo "Please open http://localhost:3000 manually"

# Restart monitoring stack
restart-monitoring:
	@echo "🔄 Restarting monitoring stack..."
	@echo "Stopping monitoring services..."
	@docker-compose down
	@echo "Starting monitoring services..."
	@docker-compose up -d
	@echo "⏳ Waiting for services to be ready..."
	@sleep 15
	@echo "✅ Monitoring stack restarted!"
	@echo "Grafana: http://localhost:3000 (admin/admin)"
	@echo "Prometheus: http://localhost:9090"
	@echo "Loki: http://localhost:3100"

# Force complete dashboard refresh (nuclear option)
reset-dashboards:
	@echo "🔄 Completely resetting Grafana dashboards..."
	@echo "Stopping Grafana..."
	@docker-compose stop grafana
	@echo "Removing Grafana container to clear cache..."
	@docker-compose rm -f grafana
	@echo "Removing Grafana data volume to clear all cached dashboards..."
	@docker volume rm walkthrough_grafana_data
	@echo "Starting fresh Grafana with clean state..."
	@docker-compose up -d grafana
	@echo "⏳ Waiting for Grafana to initialize completely..."
	@sleep 25
	@echo "✅ Grafana reset complete! All dashboards will be freshly loaded."
	@echo "Login at http://localhost:3000 with admin/admin"

# Clean up everything
clean:
	@echo "🧹 Cleaning up KubePark..."
	@docker-compose down -v
	@kind delete cluster --name kubepark-cluster
	@docker rm -f kind-registry 2>/dev/null || true
	@echo "✅ Cleanup complete!"

# Advanced commands for power users
restart-park:
	@kubectl rollout restart deployment/park -n park

restart-attractions:
	@kubectl rollout restart deployment/carousel -n attractions || true
	@kubectl rollout restart deployment/restroom -n attractions || true

# Restart Alloy log collection
restart-alloy:
	@echo "🔄 Restarting Alloy log collection..."
	@kubectl rollout restart daemonset/alloy -n alloy
	@echo "✅ Alloy restarted!"

# Upgrade Alloy with latest configuration
upgrade-alloy:
	@echo "⬆️  Upgrading Alloy configuration..."
	@helm upgrade alloy grafana/alloy --namespace alloy --values k8s/alloy-values.yaml --wait
	@echo "✅ Alloy upgraded!"


